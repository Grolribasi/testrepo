# Antora Lunr Extension
ifdef::env-gitlab[:toclevels: 1]

[Lunr](https://lunrjs.com) provides a great search experience without the need for external, server-side search services.
With this extension, you can add *offline*, full-text search powered by Lunr to your Antora documentation site.

ðŸ“Œ **NOTE:** The Antora Lunr Extension is designed for and is compatible with [Antora 3.0 and newer](https://docs.antora.org/antora/3.0/whats-new/).
To integrate Lunr with an earlier version of Antora, you must use [antora-lunr](https://github.com/Mogztter/antora-lunr) instead.

To add Lunr search to your Antora documentation site, you need to install the extension package, register the extension in your Antora playbook file, and add the search interface to the pages of your site.
Let's get started.

## Prerequisites

In order to use this extension, you must be using at least Node.js 16 and Antora 3.
We also assume you have configured an Antora playbook file (i.e., *antora-playbook.yml*) to build your site.

## Installation

Begin by installing the extension package into your [playbook project](https://docs.antora.org/antora/3.0/playbook/use-an-existing-playbook-project/):

````console
$ npm i @antora/lunr-extension
````

You also have the option of installing the extension globally by adding the `-g` flag to the `npm i` command:

````console
$ npm i -g @antora/lunr-extension
````

However, we strongly recommend installing dependencies into the playbook project.
This strategy makes it easier to manage dependencies, documents those dependencies clearly, and keeps the dependencies of the current site isolated from others.

The previous two commands will download and install the latest release of this software from the npm registry.
If you want to use the development version, you can replace the name of the package with the URL of the git repository.

````console
$ npm i https://gitlab.com/antora/antora-lunr-extension
````

Although the software in the git repository is regularly and rigorously tested, the behavior of the development version may not always match the documentation.

## Usage

### Register the extension

Now that you have the Lunr extension installed, you need to [register the extension](https://docs.antora.org/antora/3.0/extend/register-extension/) with Antora.
To register the extension, add an entry to the `antora.extensions` key in your [Antora playbook file](https://docs.antora.org/antora/3.0/playbook/).

Open the Antora playbook file and add the extension as follows:

**antora-playbook.yml**

````yaml
antora:
  extensions:
  - require: '@antora/lunr-extension'
````

ðŸ’¡ **TIP:** Alternately, you can register the extension when you run the `antora` command by using the `--extension` option.

### Generate an index file

When you generate your documentation site the next time, the extension will automatically generate an index file at the root of your output directory.
The location of this file depends on the value of `output.dir` key in your playbook.
When using the [default output dir](https://docs.antora.org/antora/3.0/playbook/configure-output/#default-output-dir), that location is *build/site/search-index.js*.

### Enable the search interface

Now that we have a search index (i.e., *search-index.js*), we need to enable the search component in the UI.

Copy the *supplemental_ui* directory from the npm package at *node_modules/@antora/lunr-extension/supplemental_ui* in your Antora playbook repository and configure the `ui.supplemental_files` key to point to that location:

**antora-playbook.yml**

````yaml
ui:
  bundle:
    url: https://gitlab.com/antora/antora-ui-default/-/jobs/artifacts/HEAD/raw/build/ui-bundle.zip?job=bundle-stable
    snapshot: true
  supplemental_files: ./supplemental_ui
````

If you're not already using a supplemental UI, you can point directly to the *supplemental_ui* directory in the npm package to avoid having to copy (and maintain) it.

**antora-playbook.yml**

````yaml
ui:
  bundle:
    url: https://gitlab.com/antora/antora-ui-default/-/jobs/artifacts/HEAD/raw/build/ui-bundle.zip?job=bundle-stable
    snapshot: true
  supplemental_files: ./node_modules/@antora/lunr-extension/supplemental_ui
````

### Set (or don't set) the site URL

You can set the site URL in the playbook to any allowable value and the search will work regardless.
(See the docs for the [site.url key](https://docs.antora.org/antora/3.0/playbook/site-url/#url-key) for details).
In fact, the `site.url` key doesn't even have to be set.

ðŸ’¡ **TIP:** If you're using the [http-server](https://www.npmjs.com/package/http-server) module to provide an HTTP server to view your site locally, you can set the `site.url` key to `+http://localhost:8080+` to emulate the conditions of a production environment.

The search works independent of the site URL because the URLs in the search results are computed *relative to the current page*.
That means the browser will resolve them regardless of where the site is deployed or on what page the search is used.
You can even use the search when viewing the site offline through a file URI.

### Generate the site

If you have registered the extension in your playbook file, then you can generate your site using the `antora` command without having to pass any additional options or environment variables.

````console
$ antora antora-playbook.yml
````

If you have not registered the extension in your playbook file, you can register it using the `--extension` CLI option of the `antora` command:

````console
$ antora --extension @antora/lunr-extension antora-playbook.yml
````

Using the `--extension` option also allows you to enable the extension that's registered in the playbook file, but marked as not enabled using the `enabled` key.
See [Enable an Extension](https://docs.antora.org/antora/3.0/extend/enable-extension/) for details about how that works.

## Configuration

ðŸ“Œ **NOTE:** In [antora-lunr](https://github.com/Mogztter/antora-lunr) (the predecessor of this extension), configuration was performed using environment variables.
In this extension, configuration is now done using configuration keys in the playbook.

### Index only the latest version

To index only the latest (i.e., released) version, set the `index_latest_only` configuration key:

**antora-playbook.yml**

````yaml
antora:
  extensions:
  - require: '@antora/lunr-extension'
    index_latest_only: true
````

By default the extension indexes all the versions of your documentation components.

### Exclude pages

You can instruct the indexer to exclude certain pages by defining the `noindex` document attribute in the AsciiDoc header:

````asciidoc
# Do Not Index Me

This content will not show up in the search results.
````

You can exclude the pages for an entire component version by defining the `noindex` AsciiDoc attribute in the component descriptor for that version:

**antora.yml**

````yaml
asciidoc:
  attributes:
    noindex: '@'
````

The indexer will also look for the `robots` meta tag in HTML document and exclude the page if the value of the content attribute is `noindex`.
That allows you to exclude pages that were either not created from AsciiDoc or that contain a meta robots tag that was added by the UI template based on another condition.

### Support for other languages

By default, Lunr only supports English as an indexing language.
You can add support for the following other languages:

* ![ar](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/IQ.png) Arabic (ar)
* ![zh](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/CN.png) Chinese (zh) (see note below)
* ![da](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/DK.png) Danish (da)
* ![nl](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/NL.png) Dutch (nl)
* ![fi](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/FI.png) Finnish (fi)
* ![fr](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/FR.png) French (fr)
* ![de](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/DE.png) German (de)
* ![hi](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/IN.png) Hindi (hi)
* ![hu](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/HU.png) Hungarian (hu)
* ![it](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/IT.png) Italian (it)
* ![ja](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/JP.png) Japanese (ja)
* ![no](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/NO.png) Norwegian (no)
* ![pt](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/PT.png) Portuguese (pt)
* ![ro](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/RO.png) Romanian (ro)
* ![ru](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/RU.png) Russian (ru)
* ![es](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/ES.png) Spanish (es)
* ![sv](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/SE.png) Swedish (sv)
* ![th](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/TH.png) Thai (th)
* ![tr](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/TR.png) Turkish (tr)
* ![vi](https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/VN.png) Vietnamese (vi)

ðŸ“Œ **NOTE:** To use Chinese as your language, you must install the `nodejieba` dependency (i.e., `npm i nodejieba`).

To use one or more languages, set the `languages` configuration key with all the desired language codes as a list:

**antora-playbook.yml**

````yaml
antora:
  extensions:
  - require: '@antora/lunr-extension'
    languages: [en, fr]
````

## UI assumptions

This section is intended for anyone designing and creating a custom UI.
This extension relies on a contract with the UI in order to minimize the configuration the user must perform to get the extension working.
Antora's default UI fulfills this contract.
For custom UIs, the assumptions of this contract are documented here.

### Environment variable

When this extension is enabled, it sets the `SITE_SEARCH_PROVIDER` environment variable to the value `lunr`.
This variable is available to the UI templates as `env.SITE_SEARCH_PROVIDER`.
The existence of this variable informs the UI template which search integration is active (in this case, Lunr).
When this variable is set, the UI is expected to add certain elements to support the extension.

ðŸ“Œ **NOTE:** If the UI you're using does not fulfill this contract, you'll need to use the supplemental UI to complete the contract.

### Search input

This extension assumes that the UI will add an input field for search somewhere in the page.
*Currently, the provided styles assume it's located in the navbar.*
The template snippet should look something like this:

````hbs
{{#if env.SITE_SEARCH_PROVIDER}}
<input id="search-input" type="text" placeholder="Search the docs">
{{/if}}
````

The UI may enclose the input in other elements in order to position it properly.
In Antora's default UI, it looks like this:

````hbs
{{#if env.SITE_SEARCH_PROVIDER}}
<div class="navbar-item search hide-for-print">
  <div id="search-field" class="field">
    <input id="search-input" type="text" placeholder="Search the docs"{{#if page.home}} autofocus{{/if}}>
  </div>
</div>
{{/if}}
````

The only requirement is that the input be of type `text` and have the ID `search-input`.

### Search scripts

This extension assumes that the UI will include the *search-scripts* partial somewhere in the footer.
This partial loads the lunr script, search UI script, and search index into the page.
The template snippet that includes this partial should look something like this:

````hbs
{{#if env.SITE_SEARCH_PROVIDER}}
{{> search-scripts}}
{{/if}}
````

The supplemental UI from this package provides this partial (*supplemental_ui/partials/search-scripts.hbs*).
In the future, the partial may be added to the UI catalog automatically by this extension.

### Search styles

The supplemental UI from this package provides additional CSS to style the search results (*supplemental_ui/css/search.css*).
This stylesheet is loaded by the search UI script also included in the supplemental UI from this package.
In the future, the stylesheet may be added to the UI catalog automatically by this extension.

If a custom UI depends on additional styles, the creator of the UI can either bundle those styles or ask the user to place an alternate stylesheet in the supplemental UI.

## Run tests

This project is built using Node.js.
In order to run the tests, you need Node.js and the development dependencies for the project.

First, make sure you have at least Node.js installed.

````console
$ node -v
````

If you don't have Node.js, you can use [nvm](https://github.com/nvm-sh/nvm) to install and manage it.

Once you have Node.js installed, run the following command to install the development dependencies:

````console
$ npm i
````

Now that you have the necessary prerequisites, you can run the tests using the following command:

````console
$ npm test
````

This command will use Mocha to run all the tests in the *tests/* folder.

Before submitting any merge request, please run the following scripts to ensure the code is properly formatted:

````console
$ npm run lint && npm run format
````

If either of these scripts fail, the build will fail.
However, you need not worry about running them until you are ready to submit your change.

## Who's using it?

Here's a list of projects using the Antora Lunr extension.

* [SUSE Manager Documentation](https://documentation.suse.com/external-tree/en-us/suma/4.0/suse-manager/)
* [Uyuni Documentation](https://www.uyuni-project.org/uyuni-docs/)
* [NTT Application Security](https://source.whitehatsec.com/help/sentinel/)
* [Commodore Components Hub (VSHN)](https://hub.syn.tools/hub/)

To add your project to this list, please [edit this file](https://gitlab.com/antora/antora-lunr-extension/-/edit/main/README.adoc)!
